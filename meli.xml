<context>
	<!--Patrones comunes-->
	<pattern name="SiNo" value="(Si|No)"/>
	
	<!--Si dice hola y no esta configurado el perfil-->
	<input pattern="* (hola) *" if="!full($Configurado) or eq($Configurado,No)">
		<context id="Configurar">
			<output value="Hola soy tu asistente buscador en Mercado Libre ¡Vamos a configurarme!"/>
			
			<!--Almacena si prefiere buscar en tiendas oficiales-->
			<output value="¿Prefires siempre las tiendas oficiales?"/>
			<input pattern="* $SiNo *" />
			<sample>
				<item>Si</item>
				<item>No</item>
			</sample>
			<var name="CodigoTiendaOficial" value="all" scope="user" if="eq($SiNo,Si)"/>
			<var name="CodigoTiendaOficial" value="" scope="user" if="eq($SiNo,No)"/>				
		
			<!--Almacena la provincia del usuario-->
			<output value="¿Cual es tu provincia?"/>
			<!--Patron de provincias disponibles-->
			<pattern name="Provincia">
				<pattern value="(Capital Federal|Bs.As. G.B.A. Sur|Córdoba)"/>
				<pattern value="(Bs.As. G.B.A. Oeste|Bs.As. G.B.A. Norte|Santa Fe)"/>
				<pattern value="(Bs.As. Costa Atlántica|Buenos Aires Interior|Tucumán)"/>
				<pattern value="(Misiones|Mendoza|Neuquén)"/>
				<pattern value="(La Pampa|Jujuy|Chaco)"/>
				<pattern value="(Formosa|La Rioja|Río Negro)"/>
				<pattern value="(Salta|San Juan|Santiago del Estero)"/>
				<pattern value="(San Luis|Santa Cruz)"/>
			</pattern>
			<input pattern="* $Provincia" />
			<sample>
				<item>Capital Federal</item>
				<item>Bs.As. G.B.A. Sur</item>
				<item>Córdoba</item>
				<item>Bs.As. G.B.A. Oeste</item>
				<item>Bs.As. G.B.A. Norte</item>
				<item>Santa Fe</item>
				<item>Bs.As. Costa Atlántica</item>
				<item>Buenos Aires Interior</item>
				<item>Tucumán</item>
				<item>Misiones</item>
				<item>Mendoza</item>
				<item>Neuquén</item>
				<item>La Pampa</item>
				<item>Jujuy</item>
				<item>Chaco</item>
				<item>Formosa</item>
				<item>La Rioja</item>
				<item>Río Negro</item>
				<item>Salta</item>
				<item>San Juan</item>
				<item>Santiago del Estero</item>
				<item>San Luis</item>
				<item>Santa Cruz</item>
			</sample>
			<!--Guarda el codigo de la provincia-->
			<var name="CodigoProvincia" value="TUxBUENBUGw3M2E1" scope="user" if="eq($Provincia,Capital Federal)"/>
			<var name="CodigoProvincia" value="TUxBUEdSQXJlMDNm" scope="user" if="eq($Provincia,Bs.As. G.B.A. Sur)"/>
			<var name="CodigoProvincia" value="TUxBUENPUmFkZGIw" scope="user" if="eq($Provincia,Córdoba)"/>
			<var name="CodigoProvincia" value="TUxBUEdSQWVmNTVm" scope="user" if="eq($Provincia,Bs.As. G.B.A. Oeste)"/>
			<var name="CodigoProvincia" value="TUxBUEdSQWU4ZDkz" scope="user" if="eq($Provincia,Bs.As. G.B.A. Norte)"/>
			<var name="CodigoProvincia" value="TUxBUFNBTmU5Nzk2" scope="user" if="eq($Provincia,Santa Fe)"/>
			<var name="CodigoProvincia" value="TUxBUENPU2ExMmFkMw" scope="user" if="eq($Provincia,Bs.As. Costa Atlántica)"/>
			<var name="CodigoProvincia" value="TUxBUFpPTmFpbnRl" scope="user" if="eq($Provincia,Buenos Aires Interior)"/>
			<var name="CodigoProvincia" value="TUxBUFRVQ244NmM3" scope="user" if="eq($Provincia,Tucumán)"/>
			<var name="CodigoProvincia" value="TUxBUE1JU3MzNjIx" scope="user" if="eq($Provincia,Misiones)"/>
			<var name="CodigoProvincia" value="TUxBUE1FTmE5OWQ4" scope="user" if="eq($Provincia,Mendoza)"/>
			<var name="CodigoProvincia" value="TUxBUE5FVW4xMzMzNQ" scope="user" if="eq($Provincia,Neuquén)"/>
			<var name="CodigoProvincia" value="TUxBUExBWmE1OWMy" scope="user" if="eq($Provincia,La Pampa)"/>
			<var name="CodigoProvincia" value="TUxBUEpVSnk3YmUz" scope="user" if="eq($Provincia,Jujuy)"/>
			<var name="CodigoProvincia" value="TUxBUENIQW8xMTNhOA" scope="user" if="eq($Provincia,Chaco)"/>
			<var name="CodigoProvincia" value="TUxBUEZPUmE1OTk5" scope="user" if="eq($Provincia,Formosa)"/>
			<var name="CodigoProvincia" value="TUxBUExBWmEyNzY0" scope="user" if="eq($Provincia,La Rioja)"/>
			<var name="CodigoProvincia" value="TUxBUFLNT29iZmZm" scope="user" if="eq($Provincia,Río Negro)"/>
			<var name="CodigoProvincia" value="TUxBUFNBTGFjMTJi" scope="user" if="eq($Provincia,Salta)"/>
			<var name="CodigoProvincia" value="TUxBUFNBTm5lYjU4" scope="user" if="eq($Provincia,San Juan)"/>
			<var name="CodigoProvincia" value="TUxBUFNBTm9lOTlk" scope="user" if="eq($Provincia,Santiago del Estero)"/>
			<var name="CodigoProvincia" value="TUxBUFNBTnM0ZTcz" scope="user" if="eq($Provincia,San Luis)"/>
			<var name="CodigoProvincia" value="TUxBUFNBTno3ZmY5" scope="user" if="eq($Provincia,Santa Cruz)"/>
			
			<!--Alamcena si prefiere productos nuevos o usados-->
			<output value="¿Prefieres productos nuevos o usados?"/>
			<pattern value="(Nuevos|Usados)" name="Condicion"/>
			<input pattern="* $Condicion"/>
			<sample>
				<item>Nuevos</item>
				<item>Usados</item>
			</sample>
			<var name="$CodigoCondicion" value="new" scope="user" if="eq($Condicion,Nuevos)"/>
			<var name="$CodigoCondicion" value="used" scope="user" if="eq($Condicion,Usados)"/>
			
			<!--Alamcena si prefiere envios gratis o solo mercado envios-->
			<output value="¿Envio gratis?"/>
			<input pattern="* $SiNo"/>
			<sample>
				<item>Si</item>
				<item>No</item>
			</sample>
			<var name="CodigoEnvioGratis" value="free" scope="user" if="eq($SiNo,Si)"/>
			<var name="CodigoEnvioGratis" value="mercadoenvios" scope="user" if="eq($SiNo,No)"/>
			
			<!--Mensaje de fin de configuracion-->
			<output>
				<item>Felicitaciones, ¡ya me has configurado!</item>
				<item>Ahora solo debes buscar tu producto</item>
				<item>Solo debes ingresar la busqueda que deseas realizar, seguido de un precio, si lo deseas y ¡Dejame el resto a mi!</item>
				<item>Ej: Me gustaria comprar un Samsung S8 a 9000 pesos</item>
			</output>
			<var name="Configurado" value="Si" scope="user"/>
		</context>
	</input>	

	<!--Si dice hola y ya esta configurado su perfil le pregunta si desea volver  configurar y ademas le recuerda como buscar-->	
	<input pattern="* (hola) *" if="full($Configurado) and eq($Configurado,Si)">	
		<context id="VolverConfigurar">
			<output>
				<item>Recuerda que para realizar una busqueda solo debes ingresar el item con su nombre.</item>
				<item>Ej: Me gustaria comprar un Samsung S8 a 9000 pesos</item>				
				<item>Ya estoy configurado con tus preferencias ¿Deseas hacerlo nuevamente?</item>
			</output>
			<input pattern="* $SiNo"/>
			<sample>
				<item>Si</item>
				<item>No</item>
			</sample>
			<var name="Configurado" value="No" scope="user" if="eq($SiNo,Si)"/>
		</context>
	</input>

	<!--Busqueda de productos especificos-->
	<input pattern="* [(dese|ansi|anhel|apete|aspir|precis|requer|urg|ped|quier|gusta|necesi)*] * [(compr|adquiri|obten|conseg|negoc|trafic|tene|posee|disfrut|guarda|conserva|ver||mirar|revisa|descrubri|intenta|proba|trata|saber de|saber cuanto sale)*] * [(una|un|a|de|en|la|lo)*] {$Busqueda::Text [* $Precio::Number]}">
		<!-- Si no se realizo una busqueda valida redirije a volver a configurar-->
		<context  id="VolverConfigurar" if="empty($Busqueda)"/>
			
		<context id="buscador">
			
			<!--Calcula un rango de precios para el que buscar productos-->
			<var name="PrecioMinimo" value="$Precio * 0.85" scope="context" if="full($Precio)"/>
			<var name="PrecioMaximo" value="$Precio * 1.15" scope="context" if="full($Precio)"/>
			<!-- Realiza una llamada a la api en busca de productos coincidentes -->
			<get url="https://api.mercadolibre.com/sites/MLA/search" var="Resultados">
				<param name="official_store" value="$CodigoTiendaOficial"/>
				<param name="state" value="$CodigoProvincia"/>
				<param name="condition" value="$CodigoCondicion"/>
				<param name="shipping" value="$CodigoEnvioGratis"/>
				<param name="has_pictures" value="yes"/>
				<param name="accepts_mercadopago" value="yes"/>
				<param name="limit" value="3"/>
				<param name="price" value="$PrecioMinimo-$PrecioMaximo" if="full($Precio)"/>
				<param name="sort" value="price_asc"/>
				<param name="q" value="$Busqueda"/>
			</get>
			<!--Obtiene la cantidad de resultados -->
			<var name="CantidadResultados" scope="context" value="get('primary_results',get('paging',$Resultados)"/>
			<!--Informa si no hay resultados -->
			<context id="SinResultados" if="$CantidadResultados==0"/>
			<!--Muestra un resultado -->
			<var name="Producto" scope="context" value="get(0,get('results',$Resultados))"/>
			<var name="TituloProducto" scope="context" value="get('title',$Prodcuto)"/>
			<var name="PrecioProducto" scope="context" value="get('price',$Prodcuto)"/>
			<var name="MonedaProducto" scope="context" value="get('currency_id',$Prodcuto)"/>
			<var name="LinkProducto" scope="context" value="get('permalink',$Prodcuto)"/>
			<var name="ImagenProducto" scope="context" value="get('thumbnail',$Prodcuto)"/>
			
			<output>
				<item>Te encontre este prodcuto de $CantidadResultados productos.</item>
				<item>$TituloProducto</item>
				<item>$PrecioProducto $MonedaProducto</item>
				<item>
					<![CDATA[
						<a href="$LinkProducto"><img src="$ImagenProducto" alt="Ver más"/></a>
					]]>		
				</item>
			</output>
		</context>
	</input>

	<context id="SinResultados">
		<output>
			<item>No pude encontrar ningun producto que coincida</item>
		</output>
	</context>

	<!--Mensaje de error cuando no se reconoce la busqueda-->
	<context id="BusquedaNoValida">
		<output>
			<item>No entiendo lo que me quieres decir.</item>
			<item>Puedes probar asi, me gustaria comprar un Samsung S8 a 9000</item>
		</output>
	</context>

</context>